# platform = multi_platform_fedora,multi_platform_ol,multi_platform_rhel,multi_platform_rhv,multi_platform_sle
# reboot = false
# strategy = restrict
# complexity = low
# disruption = low
- name: Set variable ruta
  set_fact:
    ruta: "/etc/audit/audit.rules"

- name: Check if /etc/audit/rules.d exists
  stat:
    path: /etc/audit/rules.d
  register: stat_result

- name: Set variable if /etc/audit/rules.d exists
  set_fact:
    ruta: "/etc/audit/rules.d/privileged_commands.rules"
  when: stat_result.stat.exists == True

- name: Search for privileged commands
  shell: find / -xdev -type f -perm -4000 -o -type f -perm -2000 2>/dev/null
  args:
    warn: False
    executable: /bin/bash
  check_mode: no
  register: find_result
  changed_when: false

- debug:
    msg: "{{ find_result }}"

- name: Adding remediation to audit.rules
  lineinfile:
    path: "{{ ruta }}"
    create: yes
    line: "-a always,exit -F path={{ item }} -F perm=x -F auid>=1000 -F auid!=4294967295 -k privileged"
    regexp: "'{{ item }}' \\s"
  with_items:
    - "{{ find_result.stdout_lines }}"

- name: Check if it's inmutable
  command: grep -qi "^\s*[^#]*-e 2" /etc/audit/audit.rules
  ignore_errors: True
  register: is_inmutable

- debug:
    msg: Reboot required
  when: is_inmutable.rc == 0

- name: Reload rules
  command: augenrules --load
  when: is_inmutable.rc == 1